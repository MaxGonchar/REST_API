# API Error Handling

## Introduction

Good error handling is crucial for developer experience. When something goes wrong, your API should provide clear, actionable information that helps developers understand what happened and how to fix it.

**Key principle:** Error responses should be as helpful as success responses.

---

## Why Error Handling Matters

### The Bad Error Problem

```http
# ❌ Bad: Unhelpful error
POST /users
{
  "email": "invalid-email",
  "age": "twenty"
}

HTTP/1.1 400 Bad Request
{
  "error": "Bad Request"
}
```

**What's wrong?**
- What field is invalid?
- Why is it invalid?
- How can I fix it?

```http
# ✅ Good: Helpful error
POST /users
{
  "email": "invalid-email",
  "age": "twenty"
}

HTTP/1.1 400 Bad Request
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "email",
        "message": "Must be a valid email address",
        "value": "invalid-email"
      },
      {
        "field": "age",
        "message": "Must be a number",
        "value": "twenty",
        "expected": "integer"
      }
    ]
  }
}
```

**Much better!**
- ✅ Identifies which fields are wrong
- ✅ Explains why they're wrong
- ✅ Shows what was received
- ✅ Indicates what's expected

---

## Standard Error Response Format

### Basic Structure

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable message",
    "details": "Additional information (optional)"
  }
}
```

### Comprehensive Structure

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": [
      {
        "field": "fieldName",
        "message": "Field-specific error message",
        "value": "The value that was provided",
        "constraint": "The constraint that was violated"
      }
    ],
    "timestamp": "2026-01-14T10:30:00Z",
    "requestId": "req-abc-123",
    "path": "/api/users",
    "documentation": "https://api.example.com/docs/errors/VALIDATION_ERROR"
  }
}
```

### Alternative Structures

#### Option 1: Flat Structure

```json
{
  "error": "VALIDATION_ERROR",
  "message": "Invalid email format",
  "statusCode": 400
}
```

#### Option 2: Separate Meta

```json
{
  "status": "error",
  "code": "VALIDATION_ERROR",
  "message": "Request validation failed",
  "errors": [
    {
      "field": "email",
      "message": "Invalid format"
    }
  ],
  "meta": {
    "timestamp": "2026-01-14T10:30:00Z",
    "requestId": "req-abc-123"
  }
}
```

#### Option 3: JSON:API Standard

```json
{
  "errors": [
    {
      "id": "error-uuid-123",
      "status": "400",
      "code": "INVALID_EMAIL",
      "title": "Invalid email format",
      "detail": "The email address 'invalid-email' is not valid",
      "source": {
        "pointer": "/data/attributes/email"
      }
    }
  ]
}
```

**Choose one format and be consistent across your entire API.**

---

## HTTP Status Codes for Errors

### Client Errors (4xx)

#### 400 Bad Request
**Use when:** Request is malformed or invalid

```http
POST /users
{
  "email": "not-an-email"
}

HTTP/1.1 400 Bad Request
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "email",
        "message": "Must be a valid email address"
      }
    ]
  }
}
```

#### 401 Unauthorized
**Use when:** Authentication is required but missing or invalid

```http
GET /users/me
Authorization: Bearer invalid-token

HTTP/1.1 401 Unauthorized
{
  "error": {
    "code": "INVALID_TOKEN",
    "message": "Authentication token is invalid or expired",
    "details": "Please obtain a new token by logging in"
  }
}
```

#### 403 Forbidden
**Use when:** User is authenticated but doesn't have permission

```http
DELETE /users/42
Authorization: Bearer valid-token-but-not-admin

HTTP/1.1 403 Forbidden
{
  "error": {
    "code": "INSUFFICIENT_PERMISSIONS",
    "message": "You don't have permission to delete users",
    "requiredPermission": "users.delete",
    "currentRole": "user"
  }
}
```

#### 404 Not Found
**Use when:** Resource doesn't exist

```http
GET /users/99999

HTTP/1.1 404 Not Found
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User with ID 99999 not found",
    "resourceType": "User",
    "resourceId": "99999"
  }
}
```

#### 409 Conflict
**Use when:** Request conflicts with current state

```http
POST /users
{
  "email": "existing@example.com",
  "name": "John Doe"
}

HTTP/1.1 409 Conflict
{
  "error": {
    "code": "EMAIL_ALREADY_EXISTS",
    "message": "A user with this email already exists",
    "conflictingField": "email",
    "conflictingValue": "existing@example.com",
    "existingResourceId": "42"
  }
}
```

#### 422 Unprocessable Entity
**Use when:** Request is valid but semantically incorrect

```http
POST /orders
{
  "productId": "product-123",
  "quantity": 100
}

HTTP/1.1 422 Unprocessable Entity
{
  "error": {
    "code": "INSUFFICIENT_STOCK",
    "message": "Not enough stock available",
    "details": {
      "requested": 100,
      "available": 50,
      "productId": "product-123"
    }
  }
}
```

#### 429 Too Many Requests
**Use when:** Rate limit exceeded

```http
GET /users

HTTP/1.1 429 Too Many Requests
Retry-After: 60
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1705234800

{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many requests. Please try again later",
    "retryAfter": 60,
    "limit": 100,
    "resetAt": "2026-01-14T11:00:00Z"
  }
}
```

### Server Errors (5xx)

#### 500 Internal Server Error
**Use when:** Unexpected server error

```http
GET /users

HTTP/1.1 500 Internal Server Error
{
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "An unexpected error occurred. Please try again later",
    "requestId": "req-abc-123",
    "timestamp": "2026-01-14T10:30:00Z"
  }
}
```

**⚠️ Never expose stack traces or internal details to clients in production!**

#### 503 Service Unavailable
**Use when:** Service is temporarily unavailable

```http
GET /users

HTTP/1.1 503 Service Unavailable
Retry-After: 300

{
  "error": {
    "code": "SERVICE_UNAVAILABLE",
    "message": "Service is temporarily unavailable due to maintenance",
    "retryAfter": 300,
    "estimatedRestoreTime": "2026-01-14T11:00:00Z"
  }
}
```

---

## Error Codes

### Naming Convention

```
SCREAMING_SNAKE_CASE

Examples:
- VALIDATION_ERROR
- USER_NOT_FOUND
- INVALID_TOKEN
- INSUFFICIENT_PERMISSIONS
- EMAIL_ALREADY_EXISTS
```

### Categorized Error Codes

#### Validation Errors

```javascript
VALIDATION_ERROR              // Generic validation error
REQUIRED_FIELD_MISSING        // Required field not provided
INVALID_FORMAT                // Field format is incorrect
INVALID_TYPE                  // Field type is wrong
VALUE_TOO_SHORT               // String/array too short
VALUE_TOO_LONG                // String/array too long
VALUE_OUT_OF_RANGE            // Number outside allowed range
INVALID_ENUM_VALUE            // Value not in allowed set
PATTERN_MISMATCH              // Doesn't match regex pattern
```

#### Authentication Errors

```javascript
UNAUTHORIZED                  // No authentication provided
INVALID_CREDENTIALS           // Username/password wrong
INVALID_TOKEN                 // Token is invalid
EXPIRED_TOKEN                 // Token has expired
TOKEN_REVOKED                 // Token was revoked
ACCOUNT_LOCKED                // Account is locked
ACCOUNT_DISABLED              // Account is disabled
SESSION_EXPIRED               // Session has expired
```

#### Authorization Errors

```javascript
FORBIDDEN                     // Generic permission denied
INSUFFICIENT_PERMISSIONS      // Missing required permission
RESOURCE_ACCESS_DENIED        // Can't access this resource
OPERATION_NOT_ALLOWED         // Operation not permitted
ROLE_REQUIRED                 // Specific role required
```

#### Resource Errors

```javascript
NOT_FOUND                     // Generic not found
USER_NOT_FOUND                // Specific resource not found
PRODUCT_NOT_FOUND
ORDER_NOT_FOUND
RESOURCE_DELETED              // Resource was deleted
RESOURCE_ARCHIVED             // Resource is archived
```

#### Conflict Errors

```javascript
CONFLICT                      // Generic conflict
DUPLICATE_ENTRY               // Entry already exists
EMAIL_ALREADY_EXISTS          // Specific duplicate
USERNAME_TAKEN
RESOURCE_IN_USE               // Can't delete, still in use
VERSION_CONFLICT              // Optimistic locking conflict
STATE_CONFLICT                // Invalid state transition
```

#### Business Logic Errors

```javascript
INSUFFICIENT_FUNDS            // Not enough money
INSUFFICIENT_STOCK            // Not enough inventory
ORDER_CANNOT_BE_CANCELLED     // Order in wrong state
PRODUCT_DISCONTINUED          // Product no longer available
PROMOTION_EXPIRED             // Promotion code expired
CART_EMPTY                    // Cart has no items
```

#### Rate Limiting Errors

```javascript
RATE_LIMIT_EXCEEDED           // Too many requests
QUOTA_EXCEEDED                // API quota exceeded
CONCURRENT_REQUEST_LIMIT      // Too many simultaneous requests
```

#### Server Errors

```javascript
INTERNAL_SERVER_ERROR         // Generic server error
SERVICE_UNAVAILABLE           // Service down
DATABASE_ERROR                // Database issue
EXTERNAL_SERVICE_ERROR        // Third-party API failed
TIMEOUT                       // Request timed out
```

---

## Validation Error Details

### Single Field Error

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "field": "email",
    "value": "not-an-email",
    "constraint": "email"
  }
}
```

### Multiple Field Errors

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "Must be a valid email address",
        "value": "not-an-email",
        "constraint": "email"
      },
      {
        "field": "age",
        "code": "INVALID_TYPE",
        "message": "Must be a number",
        "value": "twenty",
        "expected": "integer"
      },
      {
        "field": "password",
        "code": "VALUE_TOO_SHORT",
        "message": "Must be at least 8 characters",
        "value": "****",  // Redacted
        "constraint": "minLength: 8",
        "currentLength": 4
      },
      {
        "field": "role",
        "code": "INVALID_ENUM_VALUE",
        "message": "Must be one of: admin, user, guest",
        "value": "superuser",
        "allowedValues": ["admin", "user", "guest"]
      }
    ]
  }
}
```

### Nested Field Errors

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "address.zipCode",
        "code": "PATTERN_MISMATCH",
        "message": "Must be a valid ZIP code (5 digits)",
        "value": "abc",
        "pattern": "^\\d{5}$"
      },
      {
        "field": "items[0].quantity",
        "code": "VALUE_OUT_OF_RANGE",
        "message": "Must be between 1 and 100",
        "value": 150,
        "min": 1,
        "max": 100
      }
    ]
  }
}
```

---

## Implementation Examples

### Express.js Error Handler

```javascript
// Custom error class
class ApiError extends Error {
  constructor(statusCode, code, message, details = null) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.details = details;
    this.timestamp = new Date().toISOString();
  }
}

// Error factory functions
class ErrorFactory {
  static validationError(details) {
    return new ApiError(400, 'VALIDATION_ERROR', 'Request validation failed', details);
  }
  
  static notFound(resourceType, resourceId) {
    return new ApiError(
      404,
      `${resourceType.toUpperCase()}_NOT_FOUND`,
      `${resourceType} with ID ${resourceId} not found`,
      { resourceType, resourceId }
    );
  }
  
  static unauthorized(message = 'Authentication required') {
    return new ApiError(401, 'UNAUTHORIZED', message);
  }
  
  static forbidden(message = 'Insufficient permissions') {
    return new ApiError(403, 'FORBIDDEN', message);
  }
  
  static conflict(field, value, message) {
    return new ApiError(409, 'CONFLICT', message, { field, value });
  }
}

// Global error handler middleware
app.use((err, req, res, next) => {
  // Generate request ID if not exists
  const requestId = req.id || generateRequestId();
  
  // Log error (but not to client!)
  logger.error('API Error', {
    requestId,
    path: req.path,
    method: req.method,
    statusCode: err.statusCode || 500,
    code: err.code,
    message: err.message,
    stack: err.stack,
    user: req.user?.id
  });
  
  // Determine status code
  const statusCode = err.statusCode || 500;
  
  // Build error response
  const errorResponse = {
    error: {
      code: err.code || 'INTERNAL_SERVER_ERROR',
      message: err.message || 'An unexpected error occurred',
      ...(err.details && { details: err.details }),
      timestamp: err.timestamp || new Date().toISOString(),
      requestId,
      path: req.path
    }
  };
  
  // In development, include stack trace
  if (process.env.NODE_ENV === 'development') {
    errorResponse.error.stack = err.stack;
  }
  
  // Don't expose internal error details in production
  if (statusCode === 500 && process.env.NODE_ENV === 'production') {
    errorResponse.error.message = 'An unexpected error occurred. Please try again later.';
    delete errorResponse.error.details;
  }
  
  res.status(statusCode).json(errorResponse);
});

// Usage in route handlers
app.post('/users', async (req, res, next) => {
  try {
    // Validate request
    const errors = validateUser(req.body);
    if (errors.length > 0) {
      throw ErrorFactory.validationError(errors);
    }
    
    // Check if email exists
    const existingUser = await db.users.findByEmail(req.body.email);
    if (existingUser) {
      throw ErrorFactory.conflict(
        'email',
        req.body.email,
        'A user with this email already exists'
      );
    }
    
    // Create user
    const user = await db.users.create(req.body);
    res.status(201).json(user);
    
  } catch (error) {
    next(error);  // Pass to error handler
  }
});

app.get('/users/:id', async (req, res, next) => {
  try {
    const user = await db.users.findById(req.params.id);
    
    if (!user) {
      throw ErrorFactory.notFound('User', req.params.id);
    }
    
    res.json(user);
    
  } catch (error) {
    next(error);
  }
});
```

### Validation with Joi

```javascript
const Joi = require('joi');

// Validation schema
const userSchema = Joi.object({
  email: Joi.string().email().required(),
  name: Joi.string().min(2).max(100).required(),
  age: Joi.number().integer().min(18).max(120).required(),
  role: Joi.string().valid('admin', 'user', 'guest').default('user'),
  password: Joi.string().min(8).pattern(/[A-Z]/).pattern(/[0-9]/).required()
});

// Validation middleware
function validateRequest(schema) {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body, { abortEarly: false });
    
    if (error) {
      const details = error.details.map(detail => ({
        field: detail.path.join('.'),
        code: getValidationErrorCode(detail.type),
        message: detail.message,
        value: detail.context.value,
        constraint: detail.type
      }));
      
      throw ErrorFactory.validationError(details);
    }
    
    req.validatedBody = value;
    next();
  };
}

function getValidationErrorCode(type) {
  const codeMap = {
    'any.required': 'REQUIRED_FIELD_MISSING',
    'string.email': 'INVALID_FORMAT',
    'string.min': 'VALUE_TOO_SHORT',
    'string.max': 'VALUE_TOO_LONG',
    'number.base': 'INVALID_TYPE',
    'number.min': 'VALUE_OUT_OF_RANGE',
    'number.max': 'VALUE_OUT_OF_RANGE',
    'any.only': 'INVALID_ENUM_VALUE',
    'string.pattern.base': 'PATTERN_MISMATCH'
  };
  return codeMap[type] || 'VALIDATION_ERROR';
}

// Usage
app.post('/users', validateRequest(userSchema), async (req, res, next) => {
  try {
    const user = await db.users.create(req.validatedBody);
    res.status(201).json(user);
  } catch (error) {
    next(error);
  }
});
```

### Python/Flask Example

```python
from flask import Flask, jsonify, request
from datetime import datetime
import uuid

app = Flask(__name__)

class ApiError(Exception):
    def __init__(self, status_code, code, message, details=None):
        self.status_code = status_code
        self.code = code
        self.message = message
        self.details = details
        self.timestamp = datetime.utcnow().isoformat() + 'Z'

class ErrorFactory:
    @staticmethod
    def validation_error(details):
        return ApiError(400, 'VALIDATION_ERROR', 'Request validation failed', details)
    
    @staticmethod
    def not_found(resource_type, resource_id):
        return ApiError(
            404,
            f'{resource_type.upper()}_NOT_FOUND',
            f'{resource_type} with ID {resource_id} not found',
            {'resourceType': resource_type, 'resourceId': resource_id}
        )
    
    @staticmethod
    def unauthorized(message='Authentication required'):
        return ApiError(401, 'UNAUTHORIZED', message)

@app.errorhandler(ApiError)
def handle_api_error(error):
    response = {
        'error': {
            'code': error.code,
            'message': error.message,
            'timestamp': error.timestamp,
            'requestId': request.headers.get('X-Request-ID', str(uuid.uuid4())),
            'path': request.path
        }
    }
    
    if error.details:
        response['error']['details'] = error.details
    
    return jsonify(response), error.status_code

@app.errorhandler(Exception)
def handle_unexpected_error(error):
    # Log error
    app.logger.error(f'Unexpected error: {str(error)}', exc_info=True)
    
    # Don't expose internal errors in production
    response = {
        'error': {
            'code': 'INTERNAL_SERVER_ERROR',
            'message': 'An unexpected error occurred. Please try again later.',
            'timestamp': datetime.utcnow().isoformat() + 'Z',
            'requestId': str(uuid.uuid4()),
            'path': request.path
        }
    }
    
    return jsonify(response), 500

@app.route('/users/<int:user_id>', methods=['GET'])
def get_user(user_id):
    user = db.users.find_by_id(user_id)
    
    if not user:
        raise ErrorFactory.not_found('User', user_id)
    
    return jsonify(user)
```

---

## Error Response Best Practices

### 1. Be Consistent

**Always use the same error format across your entire API.**

```javascript
// ✅ Good: Consistent format
{
  "error": {
    "code": "...",
    "message": "..."
  }
}

// ❌ Bad: Inconsistent formats
// Sometimes:
{ "error": "message" }
// Other times:
{ "errors": ["message1", "message2"] }
// Or:
{ "message": "error", "status": "fail" }
```

### 2. Include All Context

```javascript
// ✅ Good: Detailed context
{
  "error": {
    "code": "INSUFFICIENT_STOCK",
    "message": "Not enough stock available",
    "details": {
      "productId": "product-123",
      "productName": "Blue Widget",
      "requested": 100,
      "available": 50
    }
  }
}

// ❌ Bad: Vague
{
  "error": "Not enough stock"
}
```

### 3. Be User-Friendly

```javascript
// ✅ Good: Clear, actionable
{
  "error": {
    "code": "INVALID_EMAIL",
    "message": "Please enter a valid email address (e.g., user@example.com)",
    "field": "email",
    "value": "invalid-email"
  }
}

// ❌ Bad: Technical jargon
{
  "error": {
    "code": "REGEX_VALIDATION_FAILED",
    "message": "Pattern /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/ not matched"
  }
}
```

### 4. Don't Expose Sensitive Information

```javascript
// ✅ Good: Safe error
{
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Email or password is incorrect"
  }
}

// ❌ Bad: Information leakage
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "No user found with email john@example.com"
  }
}
// ⚠️ This reveals whether an email exists in the system!
```

```javascript
// ✅ Good: Hide implementation details
{
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "An unexpected error occurred"
  }
}

// ❌ Bad: Exposes internals
{
  "error": {
    "message": "Database connection failed: ECONNREFUSED 127.0.0.1:5432",
    "stack": "Error: connect ECONNREFUSED...",
    "sql": "SELECT * FROM users WHERE email = 'user@example.com'"
  }
}
// ⚠️ Exposes database info, queries, and infrastructure!
```

### 5. Include Request ID for Debugging

```javascript
{
  "error": {
    "code": "INTERNAL_SERVER_ERROR",
    "message": "An unexpected error occurred. Please contact support with this request ID",
    "requestId": "req-abc-123-def-456",
    "timestamp": "2026-01-14T10:30:00Z"
  }
}
```

```javascript
// Implementation
const { v4: uuidv4 } = require('uuid');

app.use((req, res, next) => {
  req.id = req.headers['x-request-id'] || uuidv4();
  res.set('X-Request-ID', req.id);
  next();
});
```

### 6. Link to Documentation

```javascript
{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many requests. Please try again later",
    "documentation": "https://api.example.com/docs/errors/RATE_LIMIT_EXCEEDED",
    "help": "https://api.example.com/docs/rate-limits"
  }
}
```

### 7. Provide Solutions When Possible

```javascript
{
  "error": {
    "code": "EXPIRED_TOKEN",
    "message": "Your authentication token has expired",
    "solution": "Please log in again to obtain a new token",
    "links": {
      "login": "https://api.example.com/auth/login",
      "refresh": "https://api.example.com/auth/refresh"
    }
  }
}
```

---

## Handling Different Error Types

### Authentication Errors

```javascript
// Missing token
app.use('/api', (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({
      error: {
        code: 'MISSING_TOKEN',
        message: 'Authentication token is required',
        details: 'Include your token in the Authorization header: Bearer <token>'
      }
    });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        error: {
          code: 'EXPIRED_TOKEN',
          message: 'Authentication token has expired',
          expiredAt: error.expiredAt
        }
      });
    }
    
    return res.status(401).json({
      error: {
        code: 'INVALID_TOKEN',
        message: 'Authentication token is invalid'
      }
    });
  }
});
```

### Authorization Errors

```javascript
function requirePermission(permission) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({
        error: {
          code: 'UNAUTHORIZED',
          message: 'Authentication required'
        }
      });
    }
    
    if (!req.user.permissions.includes(permission)) {
      return res.status(403).json({
        error: {
          code: 'INSUFFICIENT_PERMISSIONS',
          message: `You don't have permission to perform this action`,
          requiredPermission: permission,
          currentPermissions: req.user.permissions,
          helpMessage: 'Contact your administrator to request access'
        }
      });
    }
    
    next();
  };
}

// Usage
app.delete('/users/:id', requirePermission('users.delete'), async (req, res) => {
  // Handler code
});
```

### Database Errors

```javascript
app.get('/users/:id', async (req, res, next) => {
  try {
    const user = await db.users.findById(req.params.id);
    
    if (!user) {
      return res.status(404).json({
        error: {
          code: 'USER_NOT_FOUND',
          message: `User with ID ${req.params.id} not found`,
          resourceType: 'User',
          resourceId: req.params.id
        }
      });
    }
    
    res.json(user);
    
  } catch (error) {
    // Log full error internally
    logger.error('Database error', {
      error: error.message,
      stack: error.stack,
      query: error.sql
    });
    
    // Return generic error to client
    res.status(500).json({
      error: {
        code: 'DATABASE_ERROR',
        message: 'Unable to retrieve user. Please try again later',
        requestId: req.id
      }
    });
  }
});
```

### External API Errors

```javascript
async function fetchExternalData(url) {
  try {
    const response = await fetch(url, { timeout: 5000 });
    
    if (!response.ok) {
      throw new ApiError(
        502,
        'EXTERNAL_SERVICE_ERROR',
        'External service returned an error',
        {
          externalStatus: response.status,
          externalService: new URL(url).hostname
        }
      );
    }
    
    return await response.json();
    
  } catch (error) {
    if (error.type === 'request-timeout') {
      throw new ApiError(
        504,
        'EXTERNAL_SERVICE_TIMEOUT',
        'External service timed out',
        {
          timeout: 5000,
          externalService: new URL(url).hostname
        }
      );
    }
    
    throw error;
  }
}
```

### Business Logic Errors

```javascript
app.post('/orders', async (req, res, next) => {
  try {
    const product = await db.products.findById(req.body.productId);
    
    if (!product) {
      return res.status(404).json({
        error: {
          code: 'PRODUCT_NOT_FOUND',
          message: 'Product not found',
          productId: req.body.productId
        }
      });
    }
    
    if (req.body.quantity > product.stock) {
      return res.status(422).json({
        error: {
          code: 'INSUFFICIENT_STOCK',
          message: 'Not enough stock available',
          details: {
            productId: product.id,
            productName: product.name,
            requested: req.body.quantity,
            available: product.stock,
            suggestion: 'Reduce quantity or check back later'
          }
        }
      });
    }
    
    if (product.status === 'discontinued') {
      return res.status(422).json({
        error: {
          code: 'PRODUCT_DISCONTINUED',
          message: 'This product is no longer available',
          productId: product.id,
          alternativeProducts: await getAlternatives(product.id)
        }
      });
    }
    
    // Create order
    const order = await db.orders.create(req.body);
    res.status(201).json(order);
    
  } catch (error) {
    next(error);
  }
});
```

---

## Localization and Internationalization

### Supporting Multiple Languages

```javascript
// Error messages in different languages
const errorMessages = {
  en: {
    VALIDATION_ERROR: 'Request validation failed',
    USER_NOT_FOUND: 'User not found',
    INVALID_EMAIL: 'Please enter a valid email address'
  },
  es: {
    VALIDATION_ERROR: 'La validación de la solicitud falló',
    USER_NOT_FOUND: 'Usuario no encontrado',
    INVALID_EMAIL: 'Por favor ingrese una dirección de correo electrónico válida'
  },
  fr: {
    VALIDATION_ERROR: 'La validation de la requête a échoué',
    USER_NOT_FOUND: 'Utilisateur non trouvé',
    INVALID_EMAIL: 'Veuillez saisir une adresse e-mail valide'
  }
};

function getErrorMessage(code, language = 'en') {
  return errorMessages[language]?.[code] || errorMessages.en[code];
}

// Usage
app.use((err, req, res, next) => {
  const language = req.headers['accept-language']?.split(',')[0]?.split('-')[0] || 'en';
  
  res.status(err.statusCode || 500).json({
    error: {
      code: err.code,
      message: getErrorMessage(err.code, language),
      details: err.details
    }
  });
});
```

### Complete Internationalized Response

```javascript
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "La validación de la solicitud falló",
    "details": [
      {
        "field": "email",
        "code": "INVALID_EMAIL",
        "message": "Por favor ingrese una dirección de correo electrónico válida",
        "value": "invalid-email"
      }
    ],
    "locale": "es"
  }
}
```

---

## Error Tracking and Monitoring

### Logging Errors

```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'error',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

app.use((err, req, res, next) => {
  // Log error with context
  logger.error('API Error', {
    requestId: req.id,
    timestamp: new Date().toISOString(),
    method: req.method,
    path: req.path,
    statusCode: err.statusCode || 500,
    errorCode: err.code,
    errorMessage: err.message,
    errorStack: err.stack,
    userId: req.user?.id,
    userAgent: req.headers['user-agent'],
    ip: req.ip,
    body: req.body,
    query: req.query,
    params: req.params
  });
  
  // Send error response
  res.status(err.statusCode || 500).json({
    error: {
      code: err.code || 'INTERNAL_SERVER_ERROR',
      message: err.message,
      requestId: req.id
    }
  });
});
```

### Integration with Error Tracking Services

```javascript
const Sentry = require('@sentry/node');

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV
});

// Request handler (first)
app.use(Sentry.Handlers.requestHandler());

// All routes
app.get('/users', async (req, res) => {
  // Your route code
});

// Error handler (last)
app.use(Sentry.Handlers.errorHandler());

// Custom error handler
app.use((err, req, res, next) => {
  // Error is already sent to Sentry by Sentry.Handlers.errorHandler()
  
  res.status(err.statusCode || 500).json({
    error: {
      code: err.code || 'INTERNAL_SERVER_ERROR',
      message: err.message,
      requestId: req.id
    }
  });
});
```

### Error Metrics and Alerting

```javascript
const prometheus = require('prom-client');

// Create metrics
const errorCounter = new prometheus.Counter({
  name: 'api_errors_total',
  help: 'Total number of API errors',
  labelNames: ['code', 'statusCode', 'path']
});

const errorRate = new prometheus.Gauge({
  name: 'api_error_rate',
  help: 'Rate of API errors per minute'
});

// Track errors
app.use((err, req, res, next) => {
  // Increment error counter
  errorCounter.inc({
    code: err.code || 'UNKNOWN',
    statusCode: err.statusCode || 500,
    path: req.path
  });
  
  // Alert on high error rate
  if (errorRate.get() > 100) {
    alerting.notify('High error rate detected', {
      rate: errorRate.get(),
      threshold: 100
    });
  }
  
  // Log and respond
  logger.error('API Error', { /* ... */ });
  res.status(err.statusCode || 500).json({ /* ... */ });
});
```

---

## Testing Error Handling

### Unit Tests

```javascript
const request = require('supertest');
const app = require('./app');

describe('Error Handling', () => {
  describe('Validation Errors', () => {
    it('should return 400 for invalid email', async () => {
      const response = await request(app)
        .post('/users')
        .send({ email: 'invalid-email', name: 'John' });
      
      expect(response.status).toBe(400);
      expect(response.body.error.code).toBe('VALIDATION_ERROR');
      expect(response.body.error.details).toHaveLength(1);
      expect(response.body.error.details[0].field).toBe('email');
    });
    
    it('should return multiple validation errors', async () => {
      const response = await request(app)
        .post('/users')
        .send({ email: 'invalid', age: 'not-a-number' });
      
      expect(response.status).toBe(400);
      expect(response.body.error.code).toBe('VALIDATION_ERROR');
      expect(response.body.error.details).toHaveLength(2);
    });
  });
  
  describe('Not Found Errors', () => {
    it('should return 404 for non-existent user', async () => {
      const response = await request(app)
        .get('/users/99999');
      
      expect(response.status).toBe(404);
      expect(response.body.error.code).toBe('USER_NOT_FOUND');
      expect(response.body.error.resourceId).toBe('99999');
    });
  });
  
  describe('Authentication Errors', () => {
    it('should return 401 without token', async () => {
      const response = await request(app)
        .get('/users/me');
      
      expect(response.status).toBe(401);
      expect(response.body.error.code).toBe('MISSING_TOKEN');
    });
    
    it('should return 401 with invalid token', async () => {
      const response = await request(app)
        .get('/users/me')
        .set('Authorization', 'Bearer invalid-token');
      
      expect(response.status).toBe(401);
      expect(response.body.error.code).toBe('INVALID_TOKEN');
    });
  });
  
  describe('Error Format', () => {
    it('should have consistent error format', async () => {
      const response = await request(app)
        .get('/users/99999');
      
      expect(response.body).toHaveProperty('error');
      expect(response.body.error).toHaveProperty('code');
      expect(response.body.error).toHaveProperty('message');
      expect(response.body.error).toHaveProperty('timestamp');
      expect(response.body.error).toHaveProperty('requestId');
    });
  });
});
```

---

## Common Mistakes

### Mistake 1: Inconsistent Error Format

```javascript
// ❌ Bad: Different formats
// Sometimes:
{ "error": "Not found" }

// Other times:
{ "message": "Not found", "status": 404 }

// Or:
{ "errors": [{ "msg": "Not found" }] }

// ✅ Good: Always the same format
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User not found"
  }
}
```

### Mistake 2: Exposing Internal Details

```javascript
// ❌ Bad: Exposes implementation
{
  "error": "MongoError: E11000 duplicate key error collection: users index: email_1 dup key: { email: \"user@example.com\" }"
}

// ✅ Good: User-friendly message
{
  "error": {
    "code": "EMAIL_ALREADY_EXISTS",
    "message": "A user with this email already exists",
    "field": "email"
  }
}
```

### Mistake 3: Vague Error Messages

```javascript
// ❌ Bad: Not helpful
{
  "error": "Invalid input"
}

// ✅ Good: Specific and actionable
{
  "error": {
    "code": "INVALID_EMAIL",
    "message": "Please enter a valid email address",
    "field": "email",
    "value": "not-an-email",
    "example": "user@example.com"
  }
}
```

### Mistake 4: Wrong Status Codes

```javascript
// ❌ Bad: 200 OK with error
{
  "status": "error",
  "message": "User not found"
}
// Status code is 200!

// ✅ Good: Proper status code
HTTP/1.1 404 Not Found
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User not found"
  }
}
```

### Mistake 5: Missing Validation Details

```javascript
// ❌ Bad: Which field is wrong?
{
  "error": "Validation failed"
}

// ✅ Good: Specific field errors
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "email",
        "message": "Must be a valid email address"
      },
      {
        "field": "age",
        "message": "Must be a number"
      }
    ]
  }
}
```

### Mistake 6: Information Disclosure

```javascript
// ❌ Bad: Security issue
POST /login
{
  "error": "No user found with email john@example.com"
}
// Reveals which emails are registered!

// ✅ Good: Generic message
POST /login
{
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Email or password is incorrect"
  }
}
```

---

## Summary

### Error Response Checklist

✅ **Consistent format** across all endpoints
✅ **Appropriate HTTP status codes**
✅ **Error codes** for programmatic handling
✅ **User-friendly messages**
✅ **Validation details** for field errors
✅ **Request ID** for debugging
✅ **Timestamp** for troubleshooting
✅ **No sensitive information** exposed
✅ **No implementation details** in production
✅ **Documentation links** when helpful
✅ **Suggestions for resolution**

### Error Format Template

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "User-friendly message",
    "details": [
      {
        "field": "fieldName",
        "code": "FIELD_ERROR_CODE",
        "message": "Field-specific message",
        "value": "provided value",
        "constraint": "constraint info"
      }
    ],
    "timestamp": "2026-01-14T10:30:00Z",
    "requestId": "req-abc-123",
    "path": "/api/endpoint",
    "documentation": "https://api.example.com/docs/errors/ERROR_CODE"
  }
}
```

### Key Principles

1. **Be consistent** - Same format everywhere
2. **Be helpful** - Clear, actionable messages
3. **Be secure** - Don't expose internals
4. **Be specific** - Include all relevant context
5. **Be trackable** - Include request IDs
6. **Be documented** - Link to error documentation

---

## Next Steps

Now that you understand error handling, explore:
- API security and authentication
- Rate limiting strategies
- Monitoring and observability
- API documentation with OpenAPI
- Client SDK error handling
- Retry strategies and circuit breakers
